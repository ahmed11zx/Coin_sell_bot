<!doctype html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
  <title>Niva Shop & Wallet</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <style type="text/tailwindcss">
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    .page { display: none; opacity: 0; transition: opacity 0.2s ease-in-out; }
    .page.active { display: block; opacity: 1; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes slideUp { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes wiggle { 0% { transform: rotate(0deg); } 25% { transform: rotate(-3deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(3deg); } 100% { transform: rotate(0deg); } }
    .animate-wiggle { animation: wiggle 2s ease-in-out infinite; }
    .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #00D27F; width: 32px; height: 32px; animation: spin 0.8s linear infinite; }
    .loading-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(4px); display:flex; flex-direction: column; justify-content:center; align-items:center; z-index:9999; }
    .payment-method-label { border: 2px solid transparent; transition: all 0.2s ease; background-color: rgba(128,128,128,0.1); }
    .payment-method-radio:checked + .payment-method-label { border-color: #00D27F; background-color: rgba(0, 210, 127, 0.15); box-shadow: 0 4px 12px rgba(0, 210, 127, 0.2); }
    
    html.light body { background-color: #F7F9FC; color: #1c1e21; }
    html.light .bg-card-background { background-color: #FFFFFF; }
    html.light .form-input { color: #111827; background-color: #FFFFFF; border: 1px solid #E5E7EB; }
    html.dark body { background-color: #0F172A; color: #F8FAFC; }
    html.dark .bg-card-background { background-color: #1E293B; border: 1px solid #334155; }
    html.dark .form-input { color: #F8FAFC; background-color: #0F172A; border: 1px solid #334155; }
  </style>
  <script id="tailwind-config">
    tailwind.config = { darkMode: "class", theme: { extend: { colors: { "primary": "#00D27F", "background": "#0F172A" } } } }
  </script>
</head>
<body class="bg-background font-display text-text-primary antialiased select-none">

  <div id="loading-overlay" class="loading-overlay hidden">
      <div class="loader"></div>
      <p id="loader-text" class="text-white mt-3 font-medium">Loading...</p>
  </div>

  <div id="app-container" class="relative min-h-screen w-full flex-col hidden overflow-hidden">
    
    <!-- Dashboard -->
    <main id="page-dashboard" class="page flex-1 pb-28">
      <div class="flex items-center p-5 pt-8">
          <div class="flex-1">
              <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Dashboard</h2>
              <h1 id="welcome-message" class="text-2xl font-extrabold text-text-primary mt-1">Welcome!</h1>
          </div>
          <div class="flex size-12 shrink-0 items-center justify-center">
              <img class="user-profile-pic object-cover rounded-full size-12 ring-2 ring-primary" src="logo19.jpg">
          </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 px-4 mt-2">
        <button data-page="page-sell-niva" class="nav-btn-internal flex items-center p-4 bg-emerald-500 rounded-2xl shadow-lg active:scale-95 transition-transform"> 
            <img src="./niva.jpg" class="h-12 w-12 rounded-full bg-white p-0.5"> 
            <div class="ml-4 text-left"><span class="block text-white font-bold text-lg">Sell Niva</span><span class="text-emerald-100 text-xs">Best Rates</span></div>
        </button>

        <button data-page="page-sell-ns" class="nav-btn-internal flex items-center p-4 bg-purple-600 rounded-2xl shadow-lg active:scale-95 transition-transform"> 
            <img src="./ns.jpg" class="h-12 w-12 rounded-full bg-white p-0.5"> 
            <div class="ml-4 text-left"><span class="block text-white font-bold text-lg">Sell Ns Coin</span><span class="text-purple-100 text-xs">Fast Pay</span></div>
        </button>

        <button data-page="page-sell-riva" class="nav-btn-internal flex items-center p-4 bg-orange-500 rounded-2xl shadow-lg active:scale-95 transition-transform"> 
            <img src="./riva.jpg" class="h-12 w-12 rounded-full bg-white p-0.5" onerror="this.src='./niva.jpg'"> 
            <div class="ml-4 text-left"><span class="block text-white font-bold text-lg">Sell Riva</span><span class="text-orange-100 text-xs">New Currency</span></div>
        </button>

        <button data-page="page-sell-top-coin" class="nav-btn-internal flex items-center p-4 bg-sky-500 rounded-2xl shadow-lg active:scale-95 transition-transform"> 
            <img src="./top.jpg" class="h-12 w-12 rounded-full bg-white p-0.5"> 
            <div class="ml-4 text-left"><span class="block text-white font-bold text-lg">Sell Top Coin</span><span class="text-sky-100 text-xs">Instant Deal</span></div>
        </button>
      </div>

      <div class="p-4 space-y-4">
        <div class="bg-amber-100 dark:bg-amber-900/30 p-5 rounded-2xl border border-amber-200">
            <h3 class="font-bold text-amber-800 dark:text-amber-400 mb-2 flex items-center gap-2"><span class="material-symbols-outlined">campaign</span> Important Notice</h3>
            <ul class="text-sm text-amber-700 dark:text-amber-300 space-y-2 list-disc list-inside font-medium">
                <li>Send money charge of à§³5 will be deducted.</li>
                <li>Contact Admin for large amount deals.</li>
                <li>Avoid providing fake transaction details.</li>
            </ul>
        </div>
        <div class="bg-blue-100 dark:bg-blue-900/30 p-5 rounded-2xl border border-blue-200">
            <h3 class="font-bold text-blue-800 dark:text-blue-400 mb-1">How it works</h3>
            <p class="text-sm text-blue-700 dark:text-blue-300 font-medium">Submit your sell request. Admins verify manually and payments are sent within 15 minutes.</p>
        </div>
      </div>
    </main>

    <!-- History Page -->
    <main id="page-history" class="page flex-grow p-4 pb-28">
        <h1 class="text-2xl font-bold mb-6 mt-4">Transaction History</h1>
        <div id="history-list" class="flex flex-col gap-3"></div>
    </main>

    <!-- Shop Page -->
    <main id="page-shop" class="page flex-grow p-4 pb-28">
        <h1 class="text-2xl font-bold mb-2 mt-4">Premium Shop</h1>
        <div id="shop-container" class="grid grid-cols-2 gap-3"></div>
    </main>

    <!-- Product Details Page -->
    <main id="page-product-details" class="page flex-grow p-4 pb-32 absolute inset-0 bg-background overflow-y-auto">
        <header class="flex items-center py-2 mb-4">
            <button class="nav-btn-internal size-10 flex items-center justify-center" data-page="page-shop"><span class="material-symbols-outlined">arrow_back</span></button>
            <h1 class="text-xl font-bold flex-1 text-center pr-8">Details</h1>
        </header>
        <div class="flex flex-col gap-4">
            <img id="detail-image" class="w-full aspect-video rounded-2xl object-cover">
            <h2 id="detail-title" class="text-2xl font-bold">...</h2>
            <p id="detail-price" class="text-3xl font-extrabold text-primary">à§³0</p>
            <button id="detail-btn-buy" class="w-full bg-primary text-black font-bold py-4 rounded-xl">Order Now</button>
        </div>
    </main>

    <!-- Coin Selling Pages (General Template) -->
    <!-- SELL NIVA -->
    <main id="page-sell-niva" class="page flex-grow p-4 pb-28">
        <header class="flex items-center py-2 mb-4"><button class="nav-btn-internal" data-page="page-dashboard"><span class="material-symbols-outlined">arrow_back</span></button><h1 class="text-xl font-bold flex-1 text-center pr-8">Sell Niva</h1></header>
        <div id="niva-transfer-id-box" class="bg-card-background border border-primary p-4 rounded-xl mb-6">
            <p class="text-xs font-bold text-gray-500">TRANSFER TO ID</p>
            <p id="niva-transfer-id" class="text-xl font-mono font-bold text-primary">earno.vate.mama</p>
        </div>
        <form id="sell-niva-form" class="space-y-4">
            <input id="niva-sender-user" required class="form-input w-full rounded-xl h-12" placeholder="Sender Username/ID">
            <input id="niva-amount-input" type="number" required class="form-input w-full rounded-xl h-12" placeholder="Amount (Niva)">
            <p id="niva-payout-text" class="text-primary text-xs font-bold text-right">Receive: à§³0.00</p>
            <div class="border-2 border-dashed border-gray-400 p-4 rounded-xl text-center relative">
                <span class="material-symbols-outlined text-3xl">add_photo_alternate</span>
                <p class="text-xs">Upload Screenshot</p>
                <input id="niva-file-input" type="file" accept="image/*,video/*" class="absolute inset-0 opacity-0" required>
                <div id="niva-preview-container" class="hidden absolute inset-0 bg-white"><img id="niva-preview-img" class="h-full w-full object-contain"></div>
            </div>
            <p class="text-[10px] text-red-500 font-bold">Always submit your history screenshot</p>
            <div class="grid grid-cols-2 gap-2">
                <input type="radio" name="paymentMethodNiva" id="niva-bk" value="Bkash" checked class="hidden peer/bk"><label for="niva-bk" class="p-3 border rounded-xl text-center peer-checked/bk:bg-primary/20 peer-checked/bk:border-primary">Bkash</label>
                <input type="radio" name="paymentMethodNiva" id="niva-ng" value="Nagad" class="hidden peer/ng"><label for="niva-ng" class="p-3 border rounded-xl text-center peer-checked/ng:bg-primary/20 peer-checked/ng:border-primary">Nagad</label>
            </div>
            <input id="niva-payment-number" required class="form-input w-full rounded-xl h-12" placeholder="Your Number (01XXXXXXXXX)">
            <button type="submit" class="w-full bg-primary text-black font-bold py-4 rounded-xl">Sell Now</button>
        </form>
    </main>

    <!-- SELL NS -->
    <main id="page-sell-ns" class="page flex-grow p-4 pb-28">
        <header class="flex items-center py-2 mb-4"><button class="nav-btn-internal" data-page="page-dashboard"><span class="material-symbols-outlined">arrow_back</span></button><h1 class="text-xl font-bold flex-1 text-center pr-8">Sell NS Coin</h1></header>
        <div id="ns-transfer-id-box" class="bg-card-background border border-purple-500 p-4 rounded-xl mb-6">
            <p class="text-xs font-bold text-gray-500">TRANSFER TO ID</p>
            <p id="ns-transfer-id" class="text-xl font-mono font-bold text-purple-500">Loading...</p>
        </div>
        <form id="sell-ns-form" class="space-y-4">
            <input id="ns-sender-user" class="form-input w-full rounded-xl h-12" placeholder="Sender Username/ID (Optional)">
            <input id="ns-amount-input" type="number" required class="form-input w-full rounded-xl h-12" placeholder="Amount (NS)">
            <p id="ns-payout-text" class="text-purple-500 text-xs font-bold text-right">Receive: à§³0.00</p>
            <div class="border-2 border-dashed border-gray-400 p-4 rounded-xl text-center relative">
                <input id="ns-file-input" type="file" accept="image/*,video/*" class="absolute inset-0 opacity-0" required>
                <p class="text-xs">Upload Screenshot</p>
            </div>
            <p class="text-[10px] text-red-500 font-bold">Always submit your history screenshot</p>
            <input id="ns-payment-number" required class="form-input w-full rounded-xl h-12" placeholder="Your Number">
            <button type="submit" class="w-full bg-purple-600 text-white font-bold py-4 rounded-xl">Sell Now</button>
        </form>
    </main>

    <!-- SELL RIVA (Renamed from Fira) -->
    <main id="page-sell-riva" class="page flex-grow p-4 pb-28">
        <header class="flex items-center py-2 mb-4"><button class="nav-btn-internal" data-page="page-dashboard"><span class="material-symbols-outlined">arrow_back</span></button><h1 class="text-xl font-bold flex-1 text-center pr-8">Sell Riva</h1></header>
        <div id="riva-transfer-id-box" class="bg-card-background border border-orange-500 p-4 rounded-xl mb-6">
            <p class="text-xs font-bold text-gray-500">TRANSFER TO ID</p>
            <p id="riva-transfer-id" class="text-xl font-mono font-bold text-orange-500">Loading...</p>
        </div>
        <form id="sell-riva-form" class="space-y-4">
            <input id="riva-amount-input" type="number" required class="form-input w-full rounded-xl h-12" placeholder="Amount (Riva)">
            <p id="riva-payout-text" class="text-orange-500 text-xs font-bold text-right">Receive: à§³0.00</p>
            <div class="border-2 border-dashed border-gray-400 p-4 rounded-xl text-center relative">
                <input id="riva-file-input" type="file" accept="video/*" class="absolute inset-0 opacity-0" required>
                <p class="text-xs">Upload Video Proof</p>
            </div>
            <p class="text-[10px] text-red-500 font-bold">Always submit your history screenshot</p>
            <input id="riva-payment-number" required class="form-input w-full rounded-xl h-12" placeholder="Your Number">
            <button type="submit" class="w-full bg-orange-500 text-white font-bold py-4 rounded-xl">Sell Now</button>
        </form>
    </main>

    <!-- SELL TOP COIN -->
    <main id="page-sell-top-coin" class="page flex-grow p-4 pb-28">
        <header class="flex items-center py-2 mb-4"><button class="nav-btn-internal" data-page="page-dashboard"><span class="material-symbols-outlined">arrow_back</span></button><h1 class="text-xl font-bold flex-1 text-center pr-8">Sell Top Coin</h1></header>
        <form id="sell-top-coin-form" class="space-y-4">
            <input id="top-coin-amount-input" type="number" required class="form-input w-full rounded-xl h-12" placeholder="Amount (Top)">
            <textarea id="top-coin-coupon-input" required class="form-input w-full rounded-xl p-4 h-24" placeholder="Paste Coupon Code"></textarea>
            <p class="text-[10px] text-red-500 font-bold">Always submit your history screenshot</p>
            <input id="top-coin-payment-number" required class="form-input w-full rounded-xl h-12" placeholder="Your Number">
            <button type="submit" class="w-full bg-sky-500 text-white font-bold py-4 rounded-xl">Sell Now</button>
        </form>
    </main>
    
    <!-- Profile & Admin -->
    <main id="page-profile" class="page flex-1 p-4 pb-28">
        <h1 class="text-2xl font-bold mb-6 mt-4">Profile</h1>
        <div id="admin-panel" class="hidden space-y-4 border-t pt-4 mt-4">
            <h2 class="font-bold text-red-500">Admin Controls</h2>
            <form id="update-settings-form" class="space-y-2">
                <input id="admin-niva-rate-1" type="number" placeholder="Niva Rate" class="form-input w-full rounded p-2">
                <input id="admin-ns-rate-1" type="number" placeholder="NS Rate" class="form-input w-full rounded p-2">
                <input id="admin-riva-rate-1" type="number" placeholder="Riva Rate" class="form-input w-full rounded p-2">
                <button type="submit" class="w-full bg-red-500 text-white py-2 rounded">Save All</button>
            </form>
        </div>
    </main>

    <!-- Navigation -->
    <div class="fixed bottom-0 left-0 right-0 h-20 bg-card-background border-t z-50">
      <div class="grid h-full grid-cols-4 max-w-lg mx-auto">
        <button class="nav-btn flex flex-col items-center justify-center" data-page="page-dashboard"><span class="material-symbols-outlined">home</span><span class="text-[10px]">Home</span></button>
        <button class="nav-btn flex flex-col items-center justify-center" data-page="page-history"><span class="material-symbols-outlined">history</span><span class="text-[10px]">History</span></button>
        <button class="nav-btn flex flex-col items-center justify-center" data-page="page-shop"><span class="material-symbols-outlined">storefront</span><span class="text-[10px]">Shop</span></button>
        <button class="nav-btn flex flex-col items-center justify-center" data-page="page-profile"><span class="material-symbols-outlined">person</span><span class="text-[10px]">Profile</span></button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const ADMIN_TELEGRAM_ID = '6703675335';
    const BOT_TOKEN = '8523876681:AAHJ3AGjdB7KpiHvrjMvq3clD5csFrVlt24';
    const CHANNEL_ID = '-1002536173839'; // Numeric ID for internal API calls
    const INVITE_LINK = 'https://t.me/+yao_mkL_RggxMmE1';
    
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => document.querySelectorAll(s);

    let telegramUser, tg;
    let marketRates = { niva: {tier1:10}, ns: {tier1:10}, riva: {tier1:10}, 'top-coin': {tier1:10} };

    // Initialize Firebase
    const firebaseConfig = { apiKey: "AIzaSyCAQtTRKgOizQjgqCbIZ_Z357LQD2Woee8", databaseURL: "https://earnovate-bot-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function startApp() {
        tg = window.Telegram.WebApp; tg.expand();
        telegramUser = tg.initDataUnsafe?.user || { id: 6703675335, first_name: 'Admin' };
        
        if (telegramUser.id.toString() === ADMIN_TELEGRAM_ID) $('#admin-panel').classList.remove('hidden');
        
        $('#app-container').classList.remove('hidden');
        $('#welcome-message').textContent = `Hi, ${telegramUser.first_name}!`;
        
        setupEventListeners();
        loadRates();
        showPage('page-dashboard');
    }

    function setupEventListeners() {
        $$('.nav-btn, .nav-btn-internal').forEach(btn => btn.onclick = () => showPage(btn.dataset.page));
        
        ['niva', 'ns', 'riva', 'top-coin'].forEach(coin => {
            const input = $(`#${coin}-amount-input`);
            if(input) input.oninput = () => calculatePayout(coin);
            const form = $(`#sell-${coin}-form`);
            if(form) form.onsubmit = (e) => handleCoinSubmit(e, coin);
        });

        $('#update-settings-form').onsubmit = handleAdminUpdate;
    }

    function calculatePayout(coin) {
        const amt = parseFloat($(`#${coin}-amount-input`).value) || 0;
        const rate = marketRates[coin]?.tier1 || 0;
        const payout = (amt / 1000 * rate).toFixed(2);
        $(`#${coin}-payout-text`).textContent = `Receive: ~à§³${payout}`;
        return { payout, rate };
    }

    async function handleCoinSubmit(e, coin) {
        e.preventDefault();
        $('#loader-text').textContent = 'Submitting...';
        $('#loading-overlay').classList.remove('hidden');

        try {
            const amt = $(`#${coin}-amount-input`).value;
            const num = $(`#${coin}-payment-number`).value;
            const sender = $(`#${coin}-sender-user`)?.value || 'N/A';
            const { payout, rate } = calculatePayout(coin);

            const msg = `ðŸš€ <b>New Sell Order: ${coin.toUpperCase()}</b>\n\n` +
                        `ðŸ‘¤ User: @${telegramUser.username || telegramUser.id}\n` +
                        `ðŸ’° Amount: ${amt}\n` +
                        `ðŸ’µ Payout: à§³${payout}\n` +
                        `ðŸ“± Number: ${num}\n` +
                        `ðŸ‘¤ Sender: ${sender}\n` +
                        `ðŸ“… ${new Date().toLocaleString()}`;

            const formData = new FormData();
            formData.append('chat_id', CHANNEL_ID);
            formData.append('parse_mode', 'HTML');

            const fileInput = $(`#${coin}-file-input`);
            let endpoint = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
            
            if(fileInput && fileInput.files[0]) {
                const file = fileInput.files[0];
                if(file.type.startsWith('video/')) {
                    endpoint = `https://api.telegram.org/bot${BOT_TOKEN}/sendVideo`;
                    formData.append('video', file);
                } else {
                    endpoint = `https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`;
                    formData.append('photo', file);
                }
                formData.append('caption', msg);
            } else {
                formData.append('text', msg);
            }

            const res = await fetch(endpoint, { method: 'POST', body: formData });
            const result = await res.json();

            if(result.ok) {
                // Save to Firebase History with Pending status
                const historyRef = db.ref(`users/${telegramUser.id}/history`).push();
                await historyRef.set({
                    coin: coin,
                    amount: amt,
                    payout: payout,
                    status: 'Pending',
                    msgId: result.result.message_id, // Store for potential tracking
                    time: Date.now()
                });

                tg.showAlert('Order Submitted! Check history for status.');
                showPage('page-dashboard');
            }
        } catch (err) {
            tg.showAlert('Error: ' + err.message);
        } finally {
            $('#loading-overlay').classList.add('hidden');
        }
    }

    function renderHistory() {
        const list = $('#history-list');
        list.innerHTML = 'Loading...';
        db.ref(`users/${telegramUser.id}/history`).on('value', (snap) => {
            const data = snap.val();
            if(!data) { list.innerHTML = 'No history.'; return; }
            
            const items = Object.values(data).reverse();
            list.innerHTML = items.map(h => `
                <div class="bg-card-background p-4 rounded-xl flex justify-between items-center shadow-sm border border-gray-100 dark:border-gray-800">
                    <div>
                        <p class="font-bold uppercase text-sm">${h.coin}</p>
                        <p class="text-xs text-gray-400">${new Date(h.time).toLocaleTimeString()}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold">à§³${h.payout}</p>
                        <span class="text-[10px] px-2 py-0.5 rounded-full font-bold ${h.status === 'Complete' ? 'bg-green-100 text-green-600' : 'bg-amber-100 text-amber-600'}">
                            ${h.status}
                        </span>
                    </div>
                </div>
            `).join('');
        });
    }

    function loadRates() {
        db.ref('rates').on('value', (s) => {
            marketRates = s.val() || marketRates;
            if(marketRates.transferIds) {
                $('#ns-transfer-id').textContent = marketRates.transferIds.ns || 'earno.vate.ns';
                $('#riva-transfer-id').textContent = marketRates.transferIds.riva || 'earno.vate.riva';
            }
        });
    }

    async function handleAdminUpdate(e) {
        e.preventDefault();
        const update = {
            niva: { tier1: parseFloat($('#admin-niva-rate-1').value) || 10 },
            ns: { tier1: parseFloat($('#admin-ns-rate-1').value) || 10 },
            riva: { tier1: parseFloat($('#admin-riva-rate-1').value) || 10 }
        };
        await db.ref('rates').update(update);
        tg.showAlert('Rates Updated');
    }

    function showPage(id) {
        $$('.page').forEach(p => p.classList.remove('active'));
        $(`#${id}`).classList.add('active');
        if(id === 'page-history') renderHistory();
        window.scrollTo(0,0);
    }

    startApp();
});
</script>
</body>
</html>
