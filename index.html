<!doctype html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Niva Coin App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <style type="text/tailwindcss">
    body { font-family: 'Inter', sans-serif; } .page { display: none; } .page.active { display: block; } 
    .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #00D27F; width: 40px; height: 40px; animation: spin 1s linear infinite; } 
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } 
    .loading-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); display:flex; flex-direction: column; justify-content:center; align-items:center; z-index:9999; }
    .payment-method-radio:checked + .payment-method-label { border-color: #00D27F; background-color: #00D27F20; }
    .status-pending { color: #FFA500; } .status-complete { color: #00D27F; }
    html.light body { background-color: #f0f2f5; color: #1c1e21; }
    html.light .bg-card-background { background-color: #ffffff; }
  </style>
  <script id="tailwind-config">tailwind.config = { darkMode: "class", theme: { extend: { colors: { "primary": "#00D27F", "background": "#000000", "card-background": "#1A1A1A", "text-primary": "#FFFFFF", "text-secondary": "#A0A0A0", }, fontFamily: { "display": ["Inter", "sans-serif"] } } } }</script>
</head>
<body class="bg-background font-display text-text-primary antialiased">

  <div id="loading-overlay" class="loading-overlay hidden"><div class="loader"></div><p id="loader-text" class="text-white mt-4"></p></div>
  <div id="error-container" class="hidden flex items-center justify-center min-h-screen p-4 text-center"><p>Please open this app inside Telegram.</p></div>
  
  <div id="app-container" class="relative min-h-screen w-full flex-col hidden">
    <!-- Dashboard -->
    <main id="page-dashboard" class="page flex-1 pb-28">
      <div class="flex items-center p-4"><h2 class="text-xl font-bold flex-1 text-text-secondary">Dashboard</h2><div class="flex size-10 shrink-0 items-center justify-end"><img class="user-profile-pic object-cover rounded-full size-10 border-2 border-primary" src="logo19.jpg" alt="User Avatar"></div></div>
      <h1 id="welcome-message" class="text-3xl font-bold px-4 pb-4 pt-4">Welcome!</h1>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 px-4 py-2">
        <button data-page="page-sell-niva" class="nav-btn-internal flex w-full items-center justify-center rounded-lg h-14 bg-emerald-500 text-white font-bold gap-3 px-4"> <img src="./niva.jpg" class="h-8 w-8 rounded-full" alt="Niva Coin"> <span>Sell Niva</span> </button>
        <button data-page="page-sell-riva" class="nav-btn-internal flex w-full items-center justify-center rounded-lg h-14 bg-purple-500 text-white font-bold gap-3 px-4"> <img src="./riva.jpg" class="h-8 w-8 rounded-full" alt="Riva Coin"> <span>Sell Riva</span> </button>
        <button data-page="page-sell-top-coin" class="nav-btn-internal flex w-full items-center justify-center rounded-lg h-14 bg-sky-500 text-white font-bold gap-3 px-4"> <img src="./top.jpg" class="h-8 w-8 rounded-full" alt="Top Coin"> <span>Sell Top Coin</span> </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4">
        <div class="col-span-1 md:col-span-2"><div class="flex flex-col rounded-lg bg-card-background p-4"><div class="flex justify-between mb-2"><p>Market Rates</p><p class="text-xs font-bold text-red-500">Live</p></div><div class="flex flex-col gap-1"><p class="text-sm">Riva Coin: <span id="dashboard-riva-rate" class="text-primary font-bold">...</span></p></div></div></div>
        <div class="col-span-1 md:col-span-2">
            <div class="bg-blue-900/30 border border-blue-600/50 p-4 rounded-xl">
                <h3 class="font-bold text-blue-400 mb-1">Information</h3>
                <p class="text-sm text-blue-200">Before selling, please check our Telegram channel for detailed instructions and rules. Your history will be updated once processed.</p>
            </div>
        </div>
      </div>
      <a href="https://t.me/+yao_mkL_RggxMmE1" target="_blank" class="fixed bottom-24 right-4 z-50 flex h-14 w-14 items-center justify-center rounded-full bg-blue-600 text-white shadow-lg"><span class="material-symbols-outlined">send</span></a>
    </main>
    
    <!-- Sell Niva Page -->
    <main id="page-sell-niva" class="page flex-grow p-4 pb-28">
        <header class="flex items-center py-2 justify-between"><button class="nav-btn-internal text-white flex size-10 items-center justify-center -ml-2" data-page="page-dashboard"><span class="material-symbols-outlined text-2xl">arrow_back</span></button><h1 class="text-lg font-bold flex-1 text-center">Sell Your Niva Coin</h1><div class="size-8"></div></header>
        <div id="niva-transfer-id-box" class="cursor-pointer bg-card-background p-3 rounded-lg flex items-center gap-4 my-4 border border-slate-700"><div class="flex-1"><p class="text-sm text-text-secondary">Transfer to ID</p><p id="niva-transfer-id" class="text-lg font-bold text-primary">earno.vate.mama</p></div><span class="material-symbols-outlined text-text-secondary">content_copy</span></div>
        <form id="sell-niva-form" class="space-y-6">
            <p class="text-xs text-amber-500 font-bold text-center italic">Always submit your history screenshot</p>
            <div><label class="block mb-2">Amount to Sell</label><input id="niva-amount-input" required class="form-input w-full rounded-lg bg-card-background h-14 p-4 border-slate-700" placeholder="e.g., 1000" type="number"/><p id="niva-payout-text" class="text-slate-300 pt-2">You will receive: ~à§³0.00</p></div>
            <div><label class="block mb-2">Sender Username (Optional)</label><input id="niva-sender-username" class="form-input w-full rounded-lg bg-card-background h-14 p-4 border-slate-700" placeholder="@username" type="text"/></div>
            <div><label class="block mb-2">Proof (Screen Recording)</label><input id="niva-file-input" required type="file" accept="video/*" class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-primary file:text-black"/></div>
            <div><h2 class="text-lg font-bold mb-3">Payment</h2><div class="grid grid-cols-2 gap-4 mb-4">
                <div><input type="radio" id="niva-bkash" name="pMethodNiva" value="Bkash" class="hidden payment-method-radio" checked><label for="niva-bkash" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg border-2 border-slate-700 cursor-pointer">Bkash</label></div>
                <div><input type="radio" id="niva-nagad" name="pMethodNiva" value="Nagad" class="hidden payment-method-radio"><label for="niva-nagad" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg border-2 border-slate-700 cursor-pointer">Nagad</label></div>
            </div><input id="niva-payment-number" required class="form-input w-full rounded-lg bg-card-background h-14 p-4 border-slate-700" placeholder="01XXXXXXXXX" type="tel"/></div>
            <button type="submit" class="w-full bg-primary text-background font-bold py-3.5 rounded-lg">Submit Order</button>
        </form>
    </main>

    <!-- Sell Riva Page -->
    <main id="page-sell-riva" class="page flex-grow p-4 pb-28">
        <header class="flex items-center py-2 justify-between"><button class="nav-btn-internal text-white flex size-10 items-center justify-center -ml-2" data-page="page-dashboard"><span class="material-symbols-outlined text-2xl">arrow_back</span></button><h1 class="text-lg font-bold flex-1 text-center">Sell Your Riva Coin</h1><div class="size-8"></div></header>
        <div id="riva-transfer-id-box" class="cursor-pointer bg-card-background p-3 rounded-lg flex items-center gap-4 my-4 border border-slate-700"><div class="flex-1"><p class="text-sm text-text-secondary">Transfer to ID</p><p id="riva-transfer-id" class="text-lg font-bold text-primary">...</p></div><span class="material-symbols-outlined text-text-secondary">content_copy</span></div>
        <form id="sell-riva-form" class="space-y-6">
            <p class="text-xs text-amber-500 font-bold text-center italic">Always submit your history screenshot</p>
            <div><label class="block mb-2">Amount to Sell</label><input id="riva-amount-input" required class="form-input w-full rounded-lg bg-card-background h-14 p-4 border-slate-700" placeholder="e.g., 1000" type="number"/><p id="riva-payout-text" class="text-slate-300 pt-2">You will receive: ~à§³0.00</p></div>
            <div><label class="block mb-2">Proof (Screen Recording)</label><input id="riva-file-input" required type="file" accept="video/*" class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-primary file:text-black"/></div>
            <div><h2 class="text-lg font-bold mb-3">Payment</h2><div class="grid grid-cols-2 gap-4 mb-4">
                <div><input type="radio" id="riva-bkash" name="pMethodRiva" value="Bkash" class="hidden payment-method-radio" checked><label for="riva-bkash" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg border-2 border-slate-700 cursor-pointer">Bkash</label></div>
                <div><input type="radio" id="riva-nagad" name="pMethodRiva" value="Nagad" class="hidden payment-method-radio"><label for="riva-nagad" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg border-2 border-slate-700 cursor-pointer">Nagad</label></div>
            </div><input id="riva-payment-number" required class="form-input w-full rounded-lg bg-card-background h-14 p-4 border-slate-700" placeholder="01XXXXXXXXX" type="tel"/></div>
            <button type="submit" class="w-full bg-primary text-background font-bold py-3.5 rounded-lg">Submit Order</button>
        </form>
    </main>

    <!-- History Page -->
    <main id="page-history" class="page flex-grow p-4 pb-28">
        <h1 class="text-xl font-bold mb-4">Transaction History</h1>
        <div id="history-list" class="space-y-4">
            <p class="text-text-secondary text-center py-10">No transactions yet.</p>
        </div>
    </main>

    <!-- Profile Page & Admin -->
    <main id="page-profile" class="page flex-1 p-4 pb-28">
      <h1 class="text-lg font-bold text-center mb-6">Settings</h1>
      <div id="admin-panel" class="hidden bg-card-background rounded-xl p-4 border border-red-900/50 mb-6">
          <h2 class="text-red-500 font-bold mb-4">Admin Controls</h2>
          <div class="space-y-4">
              <div><label class="text-xs">Riva Transfer ID</label><input id="admin-riva-id" class="w-full bg-background p-2 rounded border border-slate-700"></div>
              <div><label class="text-xs">Riva Rate (/k)</label><input id="admin-riva-rate" type="number" class="w-full bg-background p-2 rounded border border-slate-700"></div>
              <button id="admin-save-btn" class="w-full bg-red-600 font-bold py-2 rounded">Update App Data</button>
          </div>
      </div>
      <section class="flex w-full items-center gap-4 rounded-xl bg-card-background p-4 border border-slate-700">
          <div class="shrink-0"><img class="user-profile-pic rounded-full h-12 w-12 border-2 border-primary" src="logo19.jpg"></div>
          <div><p id="profile-name" class="font-bold">...</p><p id="profile-id" class="text-xs text-text-secondary">...</p></div>
      </section>
      <div class="mt-6 space-y-4">
          <a href="https://t.me/+yao_mkL_RggxMmE1" target="_blank" class="block w-full text-center bg-blue-600 py-3 rounded-lg font-bold">Join Support Channel</a>
          <button id="theme-toggle-btn" class="w-full bg-card-background border border-slate-700 py-3 rounded-lg">Toggle Dark/Light Mode</button>
      </div>
    </main>

    <!-- Bottom Navigation -->
    <div class="fixed bottom-0 left-0 right-0 h-20 bg-card-background/90 backdrop-blur-sm border-t border-slate-800">
      <div class="grid h-full max-w-lg grid-cols-3 mx-auto">
        <button class="nav-btn flex flex-col items-center justify-center" data-page="page-dashboard"><span class="material-symbols-outlined">dashboard</span><span class="text-[10px]">Home</span></button>
        <button class="nav-btn flex flex-col items-center justify-center" data-page="page-history"><span class="material-symbols-outlined">history</span><span class="text-[10px]">History</span></button>
        <button class="nav-btn flex flex-col items-center justify-center" data-page="page-profile"><span class="material-symbols-outlined">person</span><span class="text-[10px]">Profile</span></button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Config ---
    const ADMIN_TELEGRAM_ID = '6703675335';
    const BOT_TOKEN = '8523876681:AAHJ3AGjdB7KpiHvrjMvq3clD5csFrVlt24';
    const CHANNEL_ID = '-1002536173839'; // Numeric ID for API

    const $ = (s) => document.querySelector(s);
    const $$ = (s) => document.querySelectorAll(s);
    
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyCAQtTRKgOizQjgqCbIZ_Z357LQD2Woee8",
        authDomain: "earnovate-bot.firebaseapp.com",
        databaseURL: "https://earnovate-bot-default-rtdb.firebaseio.com",
        projectId: "earnovate-bot",
        appId: "1:395184310691:web:9a0a2e5ad0e954b527b216",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let tg = window.Telegram.WebApp;
    let user = tg.initDataUnsafe?.user || { id: '12345', first_name: 'LocalTest' };

    // --- App Init ---
    function init() {
        tg.ready(); tg.expand();
        $('#app-container').classList.remove('hidden');
        $('#profile-name').textContent = user.first_name;
        $('#profile-id').textContent = `ID: ${user.id}`;
        
        if (user.id.toString() === ADMIN_TELEGRAM_ID) $('#admin-panel').classList.remove('hidden');

        setupListeners();
        loadRates();
        loadHistory();
        showPage('page-dashboard');
    }

    function setupListeners() {
        $$('.nav-btn, .nav-btn-internal').forEach(b => b.onclick = () => showPage(b.dataset.page));
        
        $('#theme-toggle-btn').onclick = () => {
            document.documentElement.classList.toggle('light');
            localStorage.setItem('theme', document.documentElement.classList.contains('light') ? 'light' : 'dark');
        };

        // Calculations
        $('#niva-amount-input').oninput = (e) => calcPayout(e.target.value, 'niva');
        $('#riva-amount-input').oninput = (e) => calcPayout(e.target.value, 'riva');

        // Forms
        $('#sell-niva-form').onsubmit = (e) => handleSubmit(e, 'niva');
        $('#sell-riva-form').onsubmit = (e) => handleSubmit(e, 'riva');

        // Admin
        $('#admin-save-btn').onclick = async () => {
            const rid = $('#admin-riva-id').value;
            const rr = $('#admin-riva-rate').value;
            await db.ref('rates/riva').set({ transferId: rid, rate: rr });
            tg.showAlert('Data Updated!');
        };

        // Copy ID
        $('#niva-transfer-id-box').onclick = () => copyText($('#niva-transfer-id').textContent);
        $('#riva-transfer-id-box').onclick = () => copyText($('#riva-transfer-id').textContent);
    }

    function showPage(id) {
        $$('.page').forEach(p => p.classList.remove('active'));
        $(`#${id}`).classList.add('active');
        $$('.nav-btn').forEach(b => {
            b.classList.toggle('text-primary', b.dataset.page === id);
        });
    }

    async function loadRates() {
        db.ref('rates').on('value', s => {
            const data = s.val();
            if(!data) return;
            $('#riva-transfer-id').textContent = data.riva?.transferId || 'Updating...';
            $('#dashboard-riva-rate').textContent = `à§³${data.riva?.rate || 0}/k`;
            
            if(user.id.toString() === ADMIN_TELEGRAM_ID) {
                $('#admin-riva-id').value = data.riva?.transferId || '';
                $('#admin-riva-rate').value = data.riva?.rate || '';
            }
        });
    }

    function calcPayout(val, type) {
        db.ref(`rates/${type}/rate`).once('value', s => {
            const rate = s.val() || 0;
            const payout = ((val / 1000) * rate).toFixed(2);
            $(`#${type}-payout-text`).textContent = `You will receive: ~à§³${payout} (Rate: à§³${rate}/k)`;
        });
    }

    async function handleSubmit(e, type) {
        e.preventDefault();
        const form = e.target;
        const amount = form.querySelector('input[type="number"]').value;
        const pMethod = form.querySelector('input[type="radio"]:checked').value;
        const pNum = form.querySelector('input[type="tel"]').value;
        const file = form.querySelector('input[type="file"]').files[0];
        const extraNote = type === 'niva' ? ($('#niva-sender-username').value || 'N/A') : 'N/A';

        if(!file) return tg.showAlert('Please attach screen recording');

        $('#loading-overlay').classList.remove('hidden');
        $('#loader-text').textContent = "Submitting to Channel...";

        try {
            const orderId = Date.now();
            const msg = `ðŸš€ *New Order: ${type.toUpperCase()}*\n\nðŸ‘¤ User: ${user.first_name} (\`${user.id}\`)\nðŸ’° Amount: ${amount}\nðŸ’³ Method: ${pMethod}\nðŸ“± Number: \`${pNum}\`\nðŸ“ Note: ${extraNote}\nðŸ†” OrderID: \`${orderId}\``;

            // Send to Telegram
            const formData = new FormData();
            formData.append('chat_id', CHANNEL_ID);
            formData.append('video', file);
            formData.append('caption', msg);
            formData.append('parse_mode', 'Markdown');

            const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendVideo`, { method: 'POST', body: formData });
            const resData = await res.json();

            if(resData.ok) {
                // Save to Firebase for History
                await db.ref(`orders/${user.id}/${orderId}`).set({
                    type, amount, pMethod, pNum, status: 'Pending', time: new Date().toLocaleString()
                });
                tg.showAlert('Order submitted successfully! Keep an eye on History.');
                form.reset();
                showPage('page-history');
            } else {
                throw new Error(resData.description);
            }
        } catch (err) {
            tg.showAlert('Error: ' + err.message);
        } finally {
            $('#loading-overlay').classList.add('hidden');
        }
    }

    function loadHistory() {
        db.ref(`orders/${user.id}`).on('value', s => {
            const data = s.val();
            const container = $('#history-list');
            container.innerHTML = '';
            if(!data) { container.innerHTML = '<p class="text-center py-10 opacity-50">No history found.</p>'; return; }

            Object.keys(data).reverse().forEach(id => {
                const o = data[id];
                const card = `
                <div class="bg-card-background border border-slate-800 p-4 rounded-xl">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold">${o.type.toUpperCase()} Coin</p>
                            <p class="text-xs text-text-secondary">${o.time}</p>
                        </div>
                        <p class="font-black ${o.status === 'Complete' ? 'text-primary' : 'text-amber-500'}">${o.status}</p>
                    </div>
                    <div class="mt-2 flex justify-between text-sm">
                        <span>Amount: ${o.amount}</span>
                        <span>à§³${o.pMethod}</span>
                    </div>
                    <p class="text-[10px] opacity-30 mt-1 italic">ID: ${id}</p>
                </div>`;
                container.insertAdjacentHTML('beforeend', card);
            });
        });
    }

    function copyText(t) {
        navigator.clipboard.writeText(t);
        tg.showAlert('ID Copied!');
    }

    if(localStorage.getItem('theme') === 'light') document.documentElement.classList.add('light');
    init();
});
</script>
</body>
</html>
